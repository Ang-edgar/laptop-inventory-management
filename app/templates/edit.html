{% extends "base.html" %}
{% block title %}Edit Laptop{% endblock %}
{% block content %}
<div class="card">
    <div class="card-header">
        <h3>Edit Laptop</h3>
    </div>
    <div class="card-body">
    <form method="post" enctype="multipart/form-data">
            <div class="form-group">
                <label for="laptop_name">Laptop Name</label>
                <input type="text" id="laptop_name" name="laptop_name" class="form-control" value="{{ laptop.laptop_name }}" required>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="cpu">CPU</label>
                    <input type="text" id="cpu" name="cpu" class="form-control" value="{{ laptop.cpu }}" required>
                </div>
                <div class="form-group">
                    <label for="ram">RAM</label>
                    <input type="text" id="ram" name="ram" class="form-control" value="{{ laptop.ram }}" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="storage">Storage</label>
                    <input type="text" id="storage" name="storage" class="form-control" value="{{ laptop.storage }}" required>
                </div>
                <div class="form-group">
                    <label for="os">Operating System</label>
                    <input type="text" id="os" name="os" class="form-control" value="{{ laptop.os }}" required>
                </div>
            </div>
            <div class="form-group">
                <label for="notes">Notes</label>
                <input type="text" id="notes" name="notes" class="form-control" value="{{ laptop.notes }}">
            </div>
            
            <!-- Current Images Section -->
            <div class="form-group">
                <label>Current Images:</label><br>
                {% if images %}
                    <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 15px;">
                        {% for image in images %}
                        <div style="display: flex; flex-direction: column; border: 2px solid {% if image.is_primary %}#3b82f6{% else %}#e5e7eb{% endif %}; border-radius: 8px; padding: 5px; width: 130px; height: 160px; position: relative;">
                            <div style="flex: 1; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                                <img src="{{ url_for('serve_specific_image', laptop_id=laptop.id, image_id=image.id) }}" 
                                     alt="Laptop Image" 
                                     style="max-width: 120px; max-height: 120px; border-radius: 4px; object-fit: cover;">
                            </div>
                            {% if image.is_primary %}
                                <span style="position: absolute; top: -8px; left: -8px; background: #3b82f6; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.7rem;">PRIMARY</span>
                            {% endif %}
                            <div style="display: flex; justify-content: center; gap: 5px; margin-top: 5px;">
                                {% if not image.is_primary %}
                                    <button type="button" class="btn btn-sm btn-info" title="Set as Primary" onclick="setPrimaryImage({{ laptop.id }}, {{ image.id }})" style="display: flex; align-items: center; justify-content: center; width: 32px; height: 28px; padding: 0;">
                                        <i class="fas fa-star" style="margin: 0; padding: 0;"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-danger" title="Delete Image" onclick="deleteImage({{ laptop.id }}, {{ image.id }})" style="display: flex; align-items: center; justify-content: center; width: 32px; height: 28px; padding: 0;">
                                        <i class="fas fa-trash" style="margin: 0; padding: 0;"></i>
                                    </button>
                                {% else %}
                                    <button type="button" class="btn btn-sm btn-danger" title="Delete Image" onclick="deleteImage({{ laptop.id }}, {{ image.id }})" style="display: flex; align-items: center; justify-content: center; width: 100%; height: 28px; padding: 0;">
                                        <i class="fas fa-trash" style="margin: 0; padding: 0;"></i>
                                    </button>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                        
                        <!-- Add Image Button -->
                        <div style="display: flex; align-items: center; justify-content: center; border: 2px dashed #cbd5e1; border-radius: 8px; padding: 5px; min-width: 130px; min-height: 130px; cursor: pointer; background: #f8fafc; transition: all 0.2s;" onclick="document.getElementById('singleImageUpload').click();">
                            <div style="text-align: center; color: #64748b;">
                                <i class="fas fa-plus" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                                <p style="margin: 0; font-size: 0.9rem;">Add Image</p>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div style="text-align: center; padding: 3rem 2rem; color: #6b7280; border: 2px dashed #e5e7eb; border-radius: 8px; cursor: pointer; background: #f8fafc; transition: all 0.2s;" onclick="document.getElementById('singleImageUpload').click();">
                        <i class="fas fa-images" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <h4 style="margin-bottom: 0.5rem;">Upload Images</h4>
                        <p style="margin-bottom: 1rem;">Click to browse and select images for this laptop</p>
                        <div style="display: inline-block; background: #3b82f6; color: white; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600;">
                            <i class="fas fa-plus"></i> Browse Images
                        </div>
                    </div>
                {% endif %}
                
                <!-- Hidden file input for single image upload -->
                <input type="file" id="singleImageUpload" accept="image/*" style="display: none;" onchange="uploadSingleImage(this)">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="price_bought">Price Bought</label>
                    <input type="number" id="price_bought" name="price_bought" class="form-control" step="0.01" value="{{ laptop.price_bought }}" required>
                </div>
                <div class="form-group">
                    <label for="price_to_sell">Price to Sell</label>
                    <input type="number" id="price_to_sell" name="price_to_sell" class="form-control" step="0.01" value="{{ laptop.price_to_sell }}" required>
                </div>
                <div class="form-group">
                    <label for="fees">Fees</label>
                    <input type="number" id="fees" name="fees" class="form-control" step="0.01" value="{{ laptop.fees }}" required>
                </div>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" name="sold" {% if laptop.sold %}checked{% endif %}> Sold
                </label>
            </div>
            <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Save Changes</button>
        </form>
    </div>
</div>

<script>
function uploadSingleImage(input) {
    if (input.files && input.files[0]) {
        const formData = new FormData();
        formData.append('image', input.files[0]);
        
        // Show loading indicator
        const loadingDiv = document.createElement('div');
        loadingDiv.innerHTML = '<div style="text-align: center; padding: 1rem; color: #3b82f6;"><i class="fas fa-spinner fa-spin"></i> Uploading...</div>';
        input.parentNode.appendChild(loadingDiv);
        
        fetch(`/upload_single_image/{{ laptop.id }}`, {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.ok) {
                // Reload the page to show the new image
                window.location.reload();
            } else {
                alert('Failed to upload image');
                loadingDiv.remove();
            }
        })
        .catch(error => {
            alert('Error uploading image');
            loadingDiv.remove();
        });
        
        // Clear the input
        input.value = '';
    }
}

function deleteImage(laptopId, imageId) {
    if (confirm('Are you sure you want to delete this image?')) {
        fetch(`/delete_image/${laptopId}/${imageId}`, {
            method: 'POST'
        })
        .then(response => {
            if (response.ok) {
                // Reload the page to show the updated images
                window.location.reload();
            } else {
                alert('Failed to delete image');
            }
        })
        .catch(error => {
            alert('Error deleting image');
        });
    }
}

function setPrimaryImage(laptopId, imageId) {
    fetch(`/set_primary_image/${laptopId}/${imageId}`, {
        method: 'POST'
    })
    .then(response => {
        if (response.ok) {
            // Reload the page to show the updated primary image
            window.location.reload();
        } else {
            alert('Failed to set primary image');
        }
    })
    .catch(error => {
        alert('Error setting primary image');
    });
}
</script>
{% endblock %}